name: Auto Copilot Review

# Trigger on new PRs and updates
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-copilot-review:
    name: Auto-trigger Copilot Review
    runs-on: ubuntu-latest

    # Skip for dependabot and draft PRs, but allow workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.actor != 'dependabot[bot]' && github.event.pull_request.draft == false)

    steps:
    - name: Check gh CLI availability
      run: command -v gh || (echo "gh CLI not found" && exit 1)

    - name: Request Copilot code review
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
      run: |
        echo "ðŸ¤– Requesting Copilot code review for PR #${PR_NUMBER}"

        # Request review from Copilot using GitHub API
        # The reviewer slug for Copilot is "copilot"
        gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository }}/pulls/${PR_NUMBER}/requested_reviewers \
          -f "reviewers[]=copilot" \
        && echo "âœ… Successfully requested Copilot review" \
        || echo "âš ï¸ Failed to request Copilot review - it may already be reviewing or automatic reviews may be enabled in repository settings"

    - name: Add label
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
      run: |
        # Create label if it doesn't exist
        gh label create "copilot-review" \
          --repo ${{ github.repository }} \
          --description "Copilot code review requested" \
          --color "0075ca" 2>/dev/null || true

        # Add label to PR
        gh pr edit ${PR_NUMBER} --repo ${{ github.repository }} --add-label "copilot-review" || true

    - name: Summary
      run: |
        echo "### âœ… Copilot Review Requested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- PR #${{ github.event.pull_request.number || inputs.pr_number }} - Copilot review requested via API" >> $GITHUB_STEP_SUMMARY
        echo "- Label added: \`copilot-review\`" >> $GITHUB_STEP_SUMMARY
        echo "- Copilot will appear in the Reviewers section and provide feedback" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: If automatic reviews are enabled in repository settings, Copilot may already be reviewing." >> $GITHUB_STEP_SUMMARY
