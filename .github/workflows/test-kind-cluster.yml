name: Cluster Preparation

# Manual-only trigger. Requires Azure secrets configured in repository settings:
#   AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID, AZURE_CLIENT_ID, AZURE_CLIENT_SECRET
on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  ARO_REPO_URL: https://github.com/stolostron/cluster-api-installer.git
  ARO_REPO_BRANCH: main
  ARO_REPO_DIR: /tmp/cluster-api-installer-aro
  USE_KIND: "true"
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

jobs:
  test-kind:
    name: Cluster Preparation
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Validate Azure secrets
      run: |
        missing=""
        [ -z "$AZURE_TENANT_ID" ] && missing="$missing AZURE_TENANT_ID"
        [ -z "$AZURE_SUBSCRIPTION_ID" ] && missing="$missing AZURE_SUBSCRIPTION_ID"
        [ -z "$AZURE_CLIENT_ID" ] && missing="$missing AZURE_CLIENT_ID"
        [ -z "$AZURE_CLIENT_SECRET" ] && missing="$missing AZURE_CLIENT_SECRET"
        if [ -n "$missing" ]; then
          echo "::error::Missing required repository secrets:$missing"
          echo "Configure these in Settings > Secrets and variables > Actions"
          exit 1
        fi
        echo "All required Azure secrets are configured"

    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: go mod download

    # Tool versions - keep in sync with README.md Prerequisites
    - name: Install Kind
      run: |
        # Kind v0.20.0 - minimum version for this project
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        kind version

    - name: Install kubectl
      run: |
        # kubectl - uses latest stable (compatible with Kubernetes 1.28+)
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client

    - name: Install Helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
      with:
        # Helm 3.12+ required
        version: 'v3.16.0'

    - name: Clone cluster-api-installer repository
      run: |
        if [ -d "$ARO_REPO_DIR" ]; then
          echo "Repository already exists, skipping clone"
        else
          git clone -b "$ARO_REPO_BRANCH" "$ARO_REPO_URL" "$ARO_REPO_DIR"
          echo "Repository cloned successfully"
        fi

    - name: Run Kind cluster tests
      run: |
        mkdir -p test-results
        go run gotest.tools/gotestsum@v1.13.0 --format testname --jsonfile test-results/tests.json --junitfile test-results/junit.xml -- -v ./test -run TestKindCluster -timeout 30m
      continue-on-error: true
      id: test-run

    - name: Generate test summary
      if: always()
      run: |
        cat > summary.sh << 'SCRIPT'
        #!/bin/bash

        echo "# Kind Cluster Preparation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f test-results/tests.json ]; then
          # Parse JSON and create summary table
          echo "| Test | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Process each test event
          jq -r 'select(.Test != null and .Action != null) |
                 select(.Action == "pass" or .Action == "fail" or .Action == "skip") |
                 "| \(.Test) | \(if .Action == "pass" then "✅ PASS" elif .Action == "fail" then "❌ FAIL" else "⏭️ SKIP" end) | \(.Elapsed // 0)s |"' \
                 test-results/tests.json >> $GITHUB_STEP_SUMMARY

          # Add overall summary
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq -r 'select(.Test != null and .Action != null) | select(.Action == "pass" or .Action == "fail" or .Action == "skip")' test-results/tests.json | wc -l)
          PASSED=$(jq -r 'select(.Action == "pass")' test-results/tests.json | wc -l)
          FAILED=$(jq -r 'select(.Action == "fail")' test-results/tests.json | wc -l)
          SKIPPED=$(jq -r 'select(.Action == "skip")' test-results/tests.json | wc -l)

          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ✅ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ❌ $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped:** ⏭️ $SKIPPED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        SCRIPT

        chmod +x summary.sh
        ./summary.sh

    - name: Create test annotations
      if: always()
      run: |
        if [ -f test-results/tests.json ]; then
          jq -r 'select(.Test != null and .Action == "fail") |
                 "::error file=test/03_cluster_test.go,title=Test Failed::\(.Test) failed"' \
                 test-results/tests.json || true
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: test-results-kind-cluster
        path: test-results/
        retention-days: 30

    - name: Fail if tests failed
      if: steps.test-run.outcome == 'failure'
      run: exit 1
